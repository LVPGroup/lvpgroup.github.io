<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0156)http://localhost:60012/e878375a-7f83-431b-a556-7f03b63e3c91/preview?%2FUsers%2Fxywang%2FDesktop%2Fmi-tee%2FMiTEE_Requirement_Layer%2FMiTEE_DataStructure.thy -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style>/* Isabelle fonts */

@font-face {
  font-family: 'Isabelle DejaVu Sans';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSans.ttf') format('truetype');
}

@font-face {
  font-family: 'Isabelle DejaVu Sans';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSans-Bold.ttf') format('truetype');
  font-weight: bold;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSans-Oblique.ttf') format('truetype');
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSans-BoldOblique.ttf') format('truetype');
  font-weight: bold;
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans Mono';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSansMono.ttf') format('truetype');
}

@font-face {
  font-family: 'Isabelle DejaVu Sans Mono';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSansMono-Bold.ttf') format('truetype');
  font-weight: bold;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans Mono';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSansMono-Oblique.ttf') format('truetype');
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans Mono';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSansMono-BoldOblique.ttf') format('truetype');
  font-weight: bold;
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Serif';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSerif.ttf') format('truetype');
}

@font-face {
  font-family: 'Isabelle DejaVu Serif';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSerif-Bold.ttf') format('truetype');
  font-weight: bold;
}

@font-face {
  font-family: 'Isabelle DejaVu Serif';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSerif-Italic.ttf') format('truetype');
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Serif';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/IsabelleDejaVuSerif-BoldItalic.ttf') format('truetype');
  font-weight: bold;
  font-style: italic;
}

@font-face {
  font-family: 'Vacuous';
  src: url('/e878375a-7f83-431b-a556-7f03b63e3c91/fonts/Vacuous.ttf') format('truetype');
}


/* standard document markup */

dt {
  float: left;
  clear: left;
  padding-right: 0.5em;
  font-weight: bold;
}

body {
  color: #000000;
  background-color: #FFFFFF;
}

.head     { background-color: #FFFFFF; }
.source   {
  direction: ltr; unicode-bidi: bidi-override;
  background-color: #FFFFFF;
  padding: 10px;
  font-family: "Isabelle DejaVu Sans Mono", monospace;
}

.contents { background-color: #FFFFFF; padding: 10px; }
.sessions { background-color: #FFFFFF; padding: 10px; }
.document { white-space: normal; font-family: "Isabelle DejaVu Serif", serif; }

.name     { font-style: italic; }
.filename { font-family: "Isabelle DejaVu Sans Mono", monospace; }


/* basic syntax markup */

.hidden         { font-family: Vacuous; font-size: 1%; color: rgba(255,255,255,0); }
.control        { font-weight: bold; font-style: italic; }

.binding        { color: #336655; }
.tfree          { color: #A020F0; }
.tvar           { color: #A020F0; }
.free           { color: #0000FF; }
.skolem         { color: #D2691E; }
.bound          { color: #008000; }
.var            { color: #00009B; }
.numeral        { }
.literal        { font-weight: bold; }
.delimiter      { }
.inner_numeral  { color: #FF0000; }
.inner_quoted   { color: #FF00CC; }
.inner_cartouche { color: #CC6600; }
.comment1       { color: #CC0000; }
.comment2       { color: #FF8400; }
.comment3       { color: #6600CC; }
.dynamic        { color: #7BA428; }
.class_parameter_color { color: #D2691E; }

.bold           { font-weight: bold; }

.main           { color: #000000; }
.command        { font-weight: bold; }
.keyword        { font-weight: bold; }
.keyword1       { color: #006699; }
.keyword2       { color: #009966; }
.keyword3       { color: #0099FF; }
.quasi_keyword  { color: #9966FF; }
.operator       { color: #323232; }
.string         { color: #FF00CC; }
.alt_string     { color: #CC00CC; }
.verbatim       { color: #6600CC; }
.cartouche      { color: #CC6600; }
.comment        { color: #CC0000; }
.improper       { color: #FF5050; }
.antiquote      { color: #6600CC; }
.raw_text       { color: #6600CC; }
.plain_text     { color: #CC6600; }
.bad            { background-color: #FF6A6A; }
.quoted         { background-color: rgba(139,139,139,0.05); }
.antiquoted     { background-color: rgba(255,200,50,0.1); }


/* message background */

.writeln_message      { background-color: #F0F0F0; }
.information_message  { background-color: #DCEAF3; }
.tracing_message      { background-color: #F0F8FF; }
.warning_message      { background-color: #EEE8AA; }
.legacy_message       { background-color: #EEE8AA; }
.error_message        { background-color: #FFC1C1; }


/* message underline */

.writeln { border-bottom: 1px dotted #C0C0C0; }
.information { border-bottom: 1px dotted #C1DFEE; }
.warning { border-bottom: 1px dotted #FF8C00; }
.legacy { border-bottom: 1px dotted #FF8C00; }
.error { border-bottom: 1px dotted #B22222; }


/* tooltips */

.writeln { position: relative; display: inline-block; }
.information { position: relative; display: inline-block; }
.warning { position: relative; display: inline-block; }
.legacy { position: relative; display: inline-block; }
.error { position: relative; display: inline-block; }

.writeln:hover .tooltip { visibility: visible; }
.information:hover .tooltip { visibility: visible; }
.warning:hover .tooltip { visibility: visible; }
.legacy:hover .tooltip { visibility: visible; }
.error:hover .tooltip { visibility: visible; }

.tooltip {
  top: -0.5ex;
  left: 5em;
  visibility: hidden;
  width: 50em;
  border: 1px solid #808080;
  padding: 1px 1px;
  background-color: #FFFFE9;
  position: absolute;
  z-index: 1;
}

.tooltip pre { margin: 1px; white-space: pre-wrap; }


/* formal entities */

.entity_def {
  color: inherit;
  text-decoration: inherit;
}

.entity_def:hover {
  color: inherit;
  text-decoration: inherit;
  background-color: rgba(50,50,50,20%);
}

.entity_ref {
  color: inherit;
  text-decoration: inherit;
  border: 0.5px solid rgba(0,0,0,0);
}

.entity_ref:hover {
  color: inherit;
  text-decoration: inherit;
  background-color: rgba(50,50,50,20%);
  border: 0.5px solid black;
}
</style><title>Theory "MiTEE_DataStructure"</title></head>
<body><pre class="source"><span class="keyword1"><span class="command">theory</span></span> MiTEE_DataStructure

<span class="keyword2"><span class="keyword">imports</span></span> Main 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="document"><span class="plain_text">"DEFINITION"</span></span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> SYSTEM_TIME_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEE_UUID_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TA_UUID_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> CANCEL_TYPE <span class="main">=</span> <span class="quoted">bool</span> 
<span class="keyword1"><span class="command">type_synonym</span></span> TIMEOUT_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEE_PARAM_TYPES_TYPE <span class="main">=</span> <span class="quoted">int</span>
<span class="keyword1"><span class="command">type_synonym</span></span> BUFFER_OFFSET_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> REF_MEM_OFFSET_TYPE <span class="main">=</span> <span class="quoted">int</span>
<span class="keyword1"><span class="command">type_synonym</span></span> COMMAND_ID_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEE_DRIVER_TYPE <span class="main">=</span> <span class="quoted">int</span>
<span class="keyword1"><span class="command">type_synonym</span></span> SHM_FLAG_TYPE <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">type_synonym</span></span> SESSION_ID_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> MULTI_SESSION_TYPE <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">type_synonym</span></span> INSTANCE_KEEP_ALIVE_TYPE <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">type_synonym</span></span> SINGLE_INSTANCE_TYPE <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEEC_VALUE_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> UINT32_t <span class="main">=</span> <span class="quoted">int</span>
<span class="keyword1"><span class="command">type_synonym</span></span> FD_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> REF_CNT_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> BUSY_TYPE <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">type_synonym</span></span> THREAD_ID_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TIME_OFFSET_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TA_PRIORITY_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEE_RESULT <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> BUFFER_ID_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> BUFFER_SIZE_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> VMO_ID_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> VMO_SIZE_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">datatype</span></span> TA_MODE_TYPE <span class="main">=</span> DEAD <span class="main">|</span> COLD_START <span class="main">|</span> NORMAL
<span class="keyword1"><span class="command">type_synonym</span></span> INIT <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">type_synonym</span></span> OFFSET <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> DOMAIN_ID <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> SYSTIME <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> CHECKCODE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> Connection_Method <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> Connection_Data <span class="main">=</span> <span class="quoted">string</span>
<span class="keyword1"><span class="command">type_synonym</span></span> MEM_BLOCK_ID <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TOTAL_SIZE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> BIN_MEM_SIZE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEE_OWN_SIZE <span class="main">=</span> <span class="quoted">nat</span>

<span class="comment1">(*added 2023.2.24 for load TA service*)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> MESSAGE_HEAD_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> BIN_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> SIG_VER <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> ALGO <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> IMG_TYPE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> RESV <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> RAW_IMG_SIZE <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> RAWING_HASH <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> IMG_HASH <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> SIG <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> BIN_BODY <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">record</span></span> BIN <span class="main">=</span>
    message_head <span class="main">::</span> <span class="quoted"><span class="quoted">"MESSAGE_HEAD_TYPE"</span></span>
    bin_result <span class="main">::</span> <span class="quoted"><span class="quoted">"BIN_TYPE"</span></span>
    sig_ver <span class="main">::</span> <span class="quoted"><span class="quoted">"SIG_VER"</span></span>
    algo <span class="main">::</span> <span class="quoted"><span class="quoted">"ALGO"</span></span>
    img_type <span class="main">::</span> <span class="quoted"><span class="quoted">"IMG_TYPE"</span></span>
    resv <span class="main">::</span> <span class="quoted"><span class="quoted">"RESV"</span></span>
    raw_img_size <span class="main">::</span> <span class="quoted"><span class="quoted">"RAW_IMG_SIZE"</span></span>
    rawing_hash <span class="main">::</span> <span class="quoted"><span class="quoted">"RAWING_HASH"</span></span>
    img_hash <span class="main">::</span> <span class="quoted"><span class="quoted">"IMG_HASH"</span></span>
    sig <span class="main">::</span> <span class="quoted"><span class="quoted">"SIG"</span></span>
    bin_body <span class="main">::</span> <span class="quoted"><span class="quoted">"BIN_BODY"</span></span>  <span class="comment1">(* stand for binary code of ta *)</span>


<span class="comment1">(*size of TA bin, should get from bin but here only set to be an constant*)</span>
<span class="keyword1"><span class="command">consts</span></span> bin_mem_size<span class="main">::</span><span class="quoted"><span class="quoted">"BIN_MEM_SIZE"</span></span>
<span class="keyword1"><span class="command">consts</span></span> tee_own_size<span class="main">::</span><span class="quoted"><span class="quoted">"TEE_OWN_SIZE"</span></span>
<span class="keyword1"><span class="command">consts</span></span> someblockID1<span class="main">::</span><span class="quoted">nat</span>
<span class="keyword1"><span class="command">consts</span></span> someblockID2<span class="main">::</span><span class="quoted">nat</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">INVALID_SESSION_ID</span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">INVALID_SESSION_ID</span> <span class="main">≡</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>SESSION_ID_TYPE<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">datatype</span></span> accessFlags <span class="main">=</span> TEE_MEMORY_ACCESS_ANY_OWNER 
  <span class="main">|</span> TEE_MEMORY_ACCESS_SECURE  <span class="main">|</span> TEE_MEMORY_ACCESS_NONSECURE  <span class="main">|</span> TEE_MEMORY_ACCESS_WRITE
  <span class="main">|</span> TEE_MEMORY_ACCESS_READ

<span class="keyword1"><span class="command">datatype</span></span> hint <span class="main">=</span> TEE_MALLOC_FILL_ZERO  <span class="main">|</span>  TEE_USER_MEM_HINT_NO_FILL_ZERO

<span class="keyword1"><span class="command">datatype</span></span> RIGHT_TYPE<span class="main">=</span>TA_PERMISSION_GET_HWINFO<span class="main">|</span>TA_PERMISSION_ACCESS_MISC_DEV<span class="main">|</span>TA_PERMISSION_ACCESS_PLATFORM<span class="main">|</span>TA_PERMISSION_ACCESS_SPI

<span class="keyword1"><span class="command">record</span></span> RIGHT <span class="main">=</span> 
      hwinfo<span class="main">::</span><span class="quoted">RIGHT_TYPE</span>
      misc_dev<span class="main">::</span><span class="quoted">RIGHT_TYPE</span>
      access_platform<span class="main">::</span><span class="quoted">RIGHT_TYPE</span>
      access_api<span class="main">::</span><span class="quoted">RIGHT_TYPE</span>

<span class="keyword1"><span class="command">datatype</span></span> TEE_RETURN_CODE_TYPE <span class="main">=</span> TEE_SUCCESS 
  <span class="main">|</span> TEE_PARAM_TYPE_NONE <span class="main">|</span> TEE_PARAM_TYPE_VALUE_INPUT <span class="main">|</span> TEE_PARAM_TYPE_MEMREF_INPUT
  <span class="main">|</span> TEE_PARAM_TYPE_VALUE_OUTPUT <span class="main">|</span> TEE_PARAM_TYPE_MEMREF_OUTPUT <span class="main">|</span> TEE_PARAM_TYPE_MEMREF_INOUT
  <span class="main">|</span> TEE_ERROR_OUT_OF_MEMORY <span class="main">|</span> TEE_ERROR_ITEM_NOT_FOUND <span class="main">|</span> TEE_ERROR_ACCESS_CONFLICT
  <span class="main">|</span> TEE_ERROR_BUSY <span class="main">|</span> TEE_ERROR_TARGET_DEAD <span class="main">|</span> TEE_ERROR_CANCEL <span class="main">|</span> TEE_ERROR_BAD_PARAMETERS 
  <span class="main">|</span> TEE_ERROR_SECURITY <span class="main">|</span> TEE_ERROR_BAD_STATE <span class="main">|</span> TEE_ERROR_GENERIC


<span class="keyword1"><span class="command">datatype</span></span> TEEC_RETURN_CODE_TYPE <span class="main">=</span> TEEC_SUCCESS 
  <span class="main">|</span> TEEC_ERROR_BAD_PARAMETERS <span class="main">|</span>TEEC_ERROR_ITEM_NOT_FOUND<span class="main">|</span>TEEC_ERROR_SECURITY<span class="main">|</span>TEEC_ERROR_BUSY<span class="main">|</span> TEEC_ERROR_OUT_OF_MEMORY

<span class="keyword1"><span class="command">datatype</span></span> TEEC_RET_ORIGIN <span class="main">=</span> TEEC_ORIGIN_API<span class="main">|</span>TEEC_ORIGIN_COMMS<span class="main">|</span>TEEC_ORIGIN_TEE<span class="main">|</span>TEEC_ORIGIN_TRUSTED_APP

<span class="comment1">(*name should be a string but cant express in Isabelle, so change to nat*)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEE_NAME <span class="main">=</span> <span class="quoted">nat</span><span class="comment1">(*used in TEEC_initializeContext*)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEEC_RESULT <span class="main">=</span> <span class="quoted">TEEC_RETURN_CODE_TYPE</span>

<span class="keyword1"><span class="command">datatype</span></span> FLAGS_TYPE <span class="main">=</span> TEEC_MEM_INPUT <span class="main">|</span> TEEC_MEM_OUTPUT

<span class="keyword1"><span class="command">datatype</span></span> MEM_RIGHT <span class="main">=</span> READ<span class="main">|</span>WRITE<span class="main">|</span>READWRITE

<span class="comment1">(*describe the param type of input shared memory in openSession and invokeCommand*)</span>
<span class="keyword1"><span class="command">datatype</span></span> TEEC_MEMREF_TYPE <span class="main">=</span> TEEC_MEMREF_PARTIAL_INPUT <span class="main">|</span> TEEC_MEMREF_PARTIAL_OUTPUT <span class="main">|</span> 
                       TEEC_MEMREF_PARTIAL_INOUT

<span class="keyword1"><span class="command">datatype</span></span> TEE_MEMREF_TYPE <span class="main">=</span> TEE_MEMREF_PARTIAL_INPUT <span class="main">|</span> TEE_MEMREF_PARTIAL_OUTPUT <span class="main">|</span> 
                       TEE_MEMREF_PARTIAL_INOUT


                

<span class="comment1">(*only parameters used in registersharedmemory, not real memblock*)</span>
<span class="keyword1"><span class="command">record</span></span> TEEC_SharedMemory <span class="main">=</span>
  buffer <span class="main">::</span> <span class="quoted">MEM_BLOCK_ID</span>
  shared_size <span class="main">::</span> <span class="quoted">BUFFER_SIZE_TYPE</span>
  flags <span class="main">::</span> <span class="quoted">FLAGS_TYPE</span>
  <span class="comment1">(*TEEC_MEM_INPUT or TEEC_MEM_OUTPUT*)</span>
  shared_id <span class="main">::</span> <span class="quoted">BUFFER_ID_TYPE</span>
  alloced_size <span class="main">::</span> <span class="quoted">BUFFER_SIZE_TYPE</span>
  shadow_buffer <span class="main">::</span> <span class="quoted">MEM_BLOCK_ID</span>
  registered_fd <span class="main">::</span> <span class="quoted">FD_TYPE</span>
  buffer_allocated <span class="main">::</span> <span class="quoted">bool</span>

<span class="comment1">(*a memory block whose size is adjustable*)</span>

<span class="comment1">(*we have four memory types: TA, TA bin, REE, TEE, only TA bin can be accessed by TA and TEE*)</span>
<span class="keyword1"><span class="command">record</span></span> MemBlock <span class="main">=</span> 
          block_id <span class="main">::</span> <span class="quoted">MEM_BLOCK_ID</span>
          size <span class="main">::</span> <span class="quoted">nat</span>
          ownership <span class="main">::</span> <span class="quoted">DOMAIN_ID</span>
          access_right <span class="main">::</span> <span class="quoted"><span class="quoted">"DOMAIN_ID <span class="main">⇀</span> MEM_RIGHT"</span></span>
          is_SecureMem <span class="main">::</span> <span class="quoted">bool</span> <span class="comment1">(*secure means belong to TEE, else REE*)</span>
          related<span class="main">::</span><span class="quoted"><span class="quoted">"MEM_BLOCK_ID option"</span></span>
          

<span class="comment1">(*
  TEEC_Parameter: Memory container to be used when passing data between
      client application and trusted code.
      Either the client uses a shared memory reference, parts of it or a small raw data container.
  (1)tmpref: A temporary memory reference only valid for the duration of the operation.
  (2)memref: The entire shared memory or parts of it.
  (3)value: The small raw data container to use 
*)</span>

<span class="comment1">(*
record TEEC_PARAMETER = 
  tmpref :: "TEEC_TempMemoryReference_TYPE"
  memref :: "TEEC_RegisteredMemoryReference"
  teec_value :: "TEEC_Value" 
*)</span>

<span class="comment1">(*
datatype TEE_PARAM_TYPE = TEEC_NONE | TEEC_VALUE | tmt TEEC_MEMREF_TEMP | TEEC_MEMREF_WHOLE | TEEC_MEMREF_PARTIAL
*)</span>


<span class="comment1">(*
  [Constant Name]              |  [Equivalent on Client API]
  TEE_PARAM_TYPE_NONE          |  TEEC_NONE
  TEE_PARAM_TYPE_VALUE_INPUT   |  TEEC_VALUE_INPUT
  TEE_PARAM_TYPE_VALUE_OUTPUT  |  TEEC_VALUE_OUTPUT
  TEE_PARAM_TYPE_VALUE_INOUT   |  TEEC_VALUE_INOUT
  TEE_PARAM_TYPE_MEMREF_INPUT  |  TEEC_MEMREF_TEMP_INPUT or TEEC_MEMREF_PARTIAL_INPUT
  TEE_PARAM_TYPE_MEMREF_OUTPUT |  TEEC_MEMREF_TEMP_OUTPUT or TEEC_MEMREF_PARTIAL_OUTPUT
  TEE_PARAM_TYPE_MEMREF_INOUT  |  TEEC_MEMREF_TEMP_INOUT or TEEC_MEMREF_PARTIAL_INOUT
*)</span>
<span class="keyword1"><span class="command">datatype</span></span> TEE_PARAM_TYPE <span class="main">=</span> TEE_PARAM_TYPE_NONE <span class="main">|</span> TEE_PARAM_TYPE_VALUE <span class="main">|</span> tmt <span class="quoted">MemBlock</span>


<span class="keyword1"><span class="command">record</span></span> PARAMS_TYPE <span class="main">=</span>
   paramTypes <span class="main">::</span> <span class="quoted"><span class="quoted">"TEE_PARAM_TYPES_TYPE list"</span></span>
   paramsVal <span class="main">::</span> <span class="quoted"><span class="quoted">"TEE_PARAM_TYPE list"</span></span>
  

<span class="comment1">(* TEE_RETURN_ORIGIN_TYPE: a pointer to a variable which will contain the return origin. This field may be NULL if the return origin is not needed. *)</span>
<span class="keyword1"><span class="command">datatype</span></span> TEE_RETURN_ORIGIN_TYPE <span class="main">=</span> TEE_ORIGIN_API <span class="main">|</span> TEE_ORIGIN_COMMS <span class="main">|</span> TEE_ORIGIN_TEE <span class="main">|</span> TEE_ORIGIN_TRUSTED_APP

<span class="keyword1"><span class="command">datatype</span></span> LOGIN_TYPE <span class="main">=</span> REE_PUBLIC <span class="main">|</span> TRUSTED_APP <span class="main">|</span>KERN_IDENTITY<span class="main">|</span>DTC_IDENTITY
<span class="comment1">(*12.29: kern and dtc are for TEE,ree means nsapp*)</span>

<span class="comment1">(* 
  driver_fd: TEE driver file
  reg_mem : if TEE support dynamic shared mem then reg_mem = true 

record TEEC_CONTEXT_TYPE = 
  driver_fd :: TEE_DRIVER_TYPE
  reg_mem :: SHM_FLAG_TYPE
*)</span>

<span class="comment1">(*
  TEEC_Operation: Holds information and memory references used in TEEC_InvokeCommand()/TEEC_OpenSession().
  (1)started: Client must initialize to zero if it needs to cancel
           an operation about to be performed.
  (2)paramTypes paramsVal: params
  (3)session: Internal pointer to the last session used by TEEC_InvokeCommand with this operation.
*)</span>


<span class="keyword1"><span class="command">record</span></span> TEEC_Operation <span class="main">=</span> 
  started <span class="main">::</span> <span class="quoted"><span class="quoted">"UINT32_t"</span></span>
  paramTypes <span class="main">::</span> <span class="quoted"><span class="quoted">"TEE_PARAM_TYPES_TYPE list"</span></span>
  paramsVal <span class="main">::</span> <span class="quoted"><span class="quoted">"TEE_PARAM_TYPE list"</span></span>
 <span class="comment1">(* session :: TEEC_SESSION_TYPE*)</span>



<span class="comment1">(*client_id*)</span>
<span class="keyword1"><span class="command">record</span></span> CLIENT_TYPE <span class="main">=</span>
  login <span class="main">::</span> <span class="quoted">LOGIN_TYPE</span>
  id <span class="main">::</span> <span class="quoted"><span class="quoted">"TA_UUID_TYPE option"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DefaultClientID</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DefaultClientID</span> <span class="main">≡</span> <span class="main">⦇</span>login<span class="main">=</span>REE_PUBLIC<span class="main">,</span>id<span class="main">=</span>None<span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DefaultThreadID</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DefaultThreadID</span> <span class="main">≡</span> <span class="main">0</span><span class="main">::</span>nat"</span></span>


<span class="comment1">(*
(*including KERN and DTC, and NDSPP is REE whose login is REE_PUBLIC *)
definition KERN_IDENTITY where
      "KERN_IDENTITY ≡ ⦇ login = TRUSTED_APP,
        id = Some (1::nat)⦈ 
      "
*)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="document"><span class="plain_text">"PARAMETER for Mid functions"</span></span></span>





<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="document"><span class="plain_text">"TEE model params"</span></span></span>

<span class="comment1">(*
  TEEC_Parameter: Memory container to be used when passing data between
      client application and trusted code.
      Either the client uses a shared memory reference, parts of it or a small raw data container.
  (1)tmpref: A temporary memory reference only valid for the duration of the operation.
  (2)memref: The entire shared memory or parts of it.
  (3)value: The small raw data container to use 
*)</span>


<span class="keyword1"><span class="command">record</span></span> TEE_Memref <span class="main">=</span> 
  paramTypes <span class="main">::</span> <span class="quoted"><span class="quoted">"TEE_PARAM_TYPES_TYPE list"</span></span>
  paramsVal <span class="main">::</span> <span class="quoted"><span class="quoted">"TEE_PARAM_TYPE list"</span></span>



<span class="keyword1"><span class="command">typedecl</span></span> TEE_TASessionHandle

<span class="comment1">(*
record VMO_ATTR_TYPE =
  size :: VMO_SIZE_TYPE
  id :: VMO_ID_TYPE
*)</span>

<span class="comment1">(*-----------------------------------------------------------------------------------*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="document"><span class="plain_text">"MITEE MODEL"</span></span></span>          
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="document"><span class="plain_text">"REE model"</span></span></span>


<span class="comment1">(*
  TEEC_CONTEXT_TYPE: i.e. TEEC_context, only as parameter, for CA
  driver_fd: ca node fd
  reg_mem: if TEE support dynamic shared mem
*)</span>
<span class="keyword1"><span class="command">record</span></span> TEEC_CONTEXT_TYPE <span class="main">=</span> 
  ca_fd <span class="main">::</span> <span class="quoted">FD_TYPE</span>
  reg_mem <span class="main">::</span> <span class="quoted">SHM_FLAG_TYPE</span>

<span class="comment1">(*1.1.1 tee_ctx list in REE, designed for driver*)</span>
<span class="keyword1"><span class="command">record</span></span> TEE_CONTEXT_TYPE <span class="main">=</span> 
    ctx_fd <span class="main">::</span> <span class="quoted">FD_TYPE</span>
    tee_reg_mem <span class="main">::</span> <span class="quoted">SHM_FLAG_TYPE</span>
    driver_session_list <span class="main">::</span> <span class="quoted"><span class="quoted">"SESSION_ID_TYPE list"</span></span>
   <span class="comment1">(* lst_mem :: "MEM_BLOCK_ID list"*)</span>


<span class="comment1">(* 
TEEC_SESSION_TYPE means session between CA and TA
ctx : logic connection between client and TEE
session_id : identify a ta session between CA and TA
*)</span>

<span class="comment1">(*TBD*)</span>
<span class="keyword1"><span class="command">record</span></span> TEEC_SESSION_TYPE <span class="main">=</span> 
  teec_ctx <span class="main">::</span> <span class="quoted">TEEC_CONTEXT_TYPE</span>
  teec_session_id <span class="main">::</span> <span class="quoted">SESSION_ID_TYPE</span>




<span class="keyword1"><span class="command">record</span></span> REE_TYPE <span class="main">=</span> 
  driver_mem <span class="main">::</span> <span class="quoted"><span class="quoted">"MemBlock list"</span></span>
  tee_ctx_list <span class="main">::</span> <span class="quoted"><span class="quoted">"TEE_CONTEXT_TYPE list"</span></span>
  ree_total_size <span class="main">::</span> <span class="quoted">TOTAL_SIZE</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="document"><span class="plain_text">"TA model"</span></span></span>
<span class="keyword1"><span class="command">record</span></span> TEE_TA_ATTR_TYPE <span class="main">=</span> 
  multiSession <span class="main">::</span> <span class="quoted">MULTI_SESSION_TYPE</span>
  keepAlive <span class="main">::</span> <span class="quoted">INSTANCE_KEEP_ALIVE_TYPE</span>
  singleInstance <span class="main">::</span> <span class="quoted">SINGLE_INSTANCE_TYPE</span>

<span class="comment1">(*
  TEE_TA_TYPE: TA type in TAs

record TEE_TA_TYPE =
  ta_session_list :: "SESSION_ID_TYPE list"
  attribute :: TEE_TA_ATTR_TYPE
  ta_mem :: "TEEC_SharedMemory_TYPE list"
  ta_right :: RIGHT
  ta_init :: INIT 
(*when openSession check if INIT is false, if so,set true and execute TA_CreateEntryPoint*)
*)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="document"><span class="plain_text">"TEE model"</span></span></span>
<span class="comment1">(*TA Instance list in TA-mgr*)</span>
<span class="comment1">(* add ta_cur_session_id  *)</span>
<span class="keyword1"><span class="command">record</span></span> TA_INSTANCE_CTX_TYPE<span class="main">=</span>
  ta_id <span class="main">::</span> <span class="quoted">TA_UUID_TYPE</span>
  cur_ta_session_list <span class="main">::</span> <span class="quoted"><span class="quoted">"SESSION_ID_TYPE list"</span></span> <span class="comment1">(* cur TA is the client side of the session in the session id list *)</span>
  reference_cnt <span class="main">::</span> <span class="quoted">REF_CNT_TYPE</span>
  busy <span class="main">::</span> <span class="quoted">BUSY_TYPE</span>
  cur_ta_thread_id <span class="main">::</span> <span class="quoted">THREAD_ID_TYPE</span>
  attribute <span class="main">::</span> <span class="quoted">TEE_TA_ATTR_TYPE</span>
 <span class="comment1">(* ta_cur_session_id :: SESSION_ID_TYPE *)</span> <span class="comment1">(*not used in function logic*)</span>
 <span class="comment1">(* panicked :: bool *)</span> <span class="comment1">(*not used in function logic*)</span>


<span class="comment1">(*2.2.1 sesssion list in TA-mgr*)</span>
<span class="keyword1"><span class="command">record</span></span> TA_MGR_SESSION_TYPE <span class="main">=</span> 
  session_id <span class="main">::</span> <span class="quoted">SESSION_ID_TYPE</span>
  session_ctx <span class="main">::</span> <span class="quoted">THREAD_ID_TYPE</span> <span class="comment1">(*use thread id as a only pointer to ctx, uuid cant deal with multiInstance*)</span>
                                 <span class="comment1">(*this tid belongs to server TA*)</span>
  client_id <span class="main">::</span> <span class="quoted">CLIENT_TYPE</span>


<span class="keyword1"><span class="command">record</span></span> TEE_TA_MANAGER <span class="main">=</span>
  mgr_ta_sessions <span class="main">::</span> <span class="quoted"><span class="quoted">"TA_MGR_SESSION_TYPE list"</span></span>
  mgr_ta_instances <span class="main">::</span> <span class="quoted"><span class="quoted">"TA_INSTANCE_CTX_TYPE list"</span></span>
  BIDpointer <span class="main">::</span> <span class="quoted">nat</span> <span class="comment1">(*the pointer for allocation of mem block id on TEE side
                      , plus one after allocate once*)</span>
  <span class="comment1">(*createdVmo :: "TEE_UUID_TYPE × VMO_ID_TYPE ⇀ VMO_ATTR_TYPE"*)</span>
  <span class="comment1">(*TBD*)</span>


<span class="keyword1"><span class="command">record</span></span> ZIRCON_TYPE <span class="main">=</span>  
  property <span class="main">::</span> <span class="quoted"><span class="quoted">"TA_UUID_TYPE <span class="main">⇀</span> TA_PRIORITY_TYPE"</span></span>
<span class="comment1">(*TBD*)</span>


<span class="comment1">(*
  TEE/REE IPC DRIVER_TYPE
*)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TEE_REE_IPC_DRIVER_TYPE<span class="main">=</span><span class="quoted">nat</span>

<span class="keyword1"><span class="command">record</span></span> TEE_TYPE <span class="main">=</span> 
  ta_mgr <span class="main">::</span> <span class="quoted">TEE_TA_MANAGER</span>
  tee_ree_ipc_driver <span class="main">::</span> <span class="quoted">TEE_REE_IPC_DRIVER_TYPE</span>
  zircon <span class="main">::</span> <span class="quoted">ZIRCON_TYPE</span>
  tee_memories <span class="main">::</span> <span class="quoted"><span class="quoted">"MemBlock list"</span></span>
  tee_total_size <span class="main">::</span> <span class="quoted">TOTAL_SIZE</span>



<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="document"><span class="plain_text">"State and Configuration"</span></span></span> 

<span class="keyword1"><span class="command">record</span></span> BIN_Handle <span class="main">=</span>
    mem_block <span class="main">::</span> <span class="quoted"><span class="quoted">"MemBlock option"</span></span>
    tabin <span class="main">::</span> <span class="quoted"><span class="quoted">"BIN option"</span></span>

<span class="keyword1"><span class="command">consts</span></span> binHandle<span class="main">::</span><span class="quoted"><span class="quoted">"BIN_Handle option"</span></span>



<span class="comment1">(*datatype TA_CONF = TAConf TA_UUID_TYPE "SESSION list" TEE_TA_ATTR_TYPE "MEM_BLOCK_ID list" RIGHT INIT OFFSET BIN*)</span>
<span class="keyword1"><span class="command">datatype</span></span> TA_CONF <span class="main">=</span> TAConf <span class="quoted">TA_UUID_TYPE</span>  <span class="quoted">TEE_TA_ATTR_TYPE</span> <span class="quoted">RIGHT</span> <span class="quoted">INIT</span> <span class="quoted">OFFSET</span> <span class="quoted">BIN</span>
<span class="keyword1"><span class="command">type_synonym</span></span> TAs <span class="main">=</span> <span class="quoted"><span class="quoted">"TA_UUID_TYPE<span class="main">⇀</span>TA_CONF"</span></span>

<span class="comment1">(*basic system configuration of MiTEE*)</span>
<span class="keyword1"><span class="command">record</span></span> Sys_Config <span class="main">=</span> 
                    REE <span class="main">::</span> <span class="quoted">DOMAIN_ID</span> 
                    TEE <span class="main">::</span> <span class="quoted">DOMAIN_ID</span>
                    TA_conf <span class="main">::</span> <span class="quoted">TAs</span>
                    checkcode <span class="main">::</span> <span class="quoted">CHECKCODE</span>
                    TEE_name <span class="main">::</span> <span class="quoted">TEE_NAME</span>
                    DefaultREESize <span class="main">::</span> <span class="quoted">TOTAL_SIZE</span>
                    DefaultTEESize <span class="main">::</span> <span class="quoted">TOTAL_SIZE</span>
          

<span class="keyword1"><span class="command">record</span></span> TA_State_Type <span class="main">=</span> 
                TA_mode <span class="main">::</span> <span class="quoted">TA_MODE_TYPE</span>
                TA_sessions <span class="main">::</span> <span class="quoted"><span class="quoted">"SESSION_ID_TYPE list"</span></span> <span class="comment1">(* cur TA is the server side of the session in the session id list *)</span>
               <span class="comment1">(* TA_memories :: "MemBlock list" *)</span>
                TA_instance_init <span class="main">::</span> <span class="quoted">INIT</span>
                TA_attribute <span class="main">::</span> <span class="quoted">TEE_TA_ATTR_TYPE</span>
                

<span class="keyword1"><span class="command">type_synonym</span></span> TAs_State <span class="main">=</span> <span class="quoted"><span class="quoted">"THREAD_ID_TYPE<span class="main">⇀</span>TA_State_Type"</span></span>



<span class="keyword1"><span class="command">record</span></span> EVENT_PARAM <span class="main">=</span>
                   param1<span class="main">::</span><span class="quoted"><span class="quoted">"nat option"</span></span>
                   param2<span class="main">::</span><span class="quoted"><span class="quoted">"nat option"</span></span>
                   param3<span class="main">::</span><span class="quoted"><span class="quoted">"TEEC_Operation option"</span></span>
                   param4<span class="main">::</span><span class="quoted"><span class="quoted">"CLIENT_TYPE option"</span></span>
                   param5<span class="main">::</span><span class="quoted"><span class="quoted">"TEEC_CONTEXT_TYPE option"</span></span>
                   param6<span class="main">::</span><span class="quoted"><span class="quoted">"nat option"</span></span>
                   param7<span class="main">::</span><span class="quoted"><span class="quoted">"PARAMS_TYPE option"</span></span>
                   param8<span class="main">::</span><span class="quoted"><span class="quoted">"PARAMS_TYPE option"</span></span>
                   param9<span class="main">::</span><span class="quoted"><span class="quoted">"TA_INSTANCE_CTX_TYPE option"</span></span>
                   param10<span class="main">::</span><span class="quoted"><span class="quoted">"MemBlock option"</span></span><span class="comment1">(*12.18 added*)</span>
                   param11<span class="main">::</span><span class="quoted"><span class="quoted">"TEEC_MEMREF_TYPE option"</span></span><span class="comment1">(*12.18 added*)</span>
                   param12<span class="main">::</span><span class="quoted"><span class="quoted">"TEEC_RETURN_CODE_TYPE option"</span></span><span class="comment1">(*1.5 added*)</span>
                   param13<span class="main">::</span><span class="quoted"><span class="quoted">"TEE_RETURN_CODE_TYPE option"</span></span> <span class="comment1">(*1.5 added*)</span>

<span class="keyword1"><span class="command">datatype</span></span> EVENT_NAME <span class="main">=</span> TEEC_OP1<span class="main">|</span>TEEC_OP2<span class="main">|</span>TEEC_OP3<span class="main">|</span>TEEC_OP4<span class="main">|</span>TEE_OP1<span class="main">|</span>TEE_OP2<span class="main">|</span>TEE_OP3<span class="main">|</span>TEE_OP4<span class="main">|</span>TEE_IC1<span class="main">|</span>TEE_IC2<span class="main">|</span>TEE_IC3<span class="main">|</span>TEE_IC4
                      <span class="main">|</span>TEE_CS1<span class="main">|</span>TEE_CS2<span class="main">|</span>TEE_CS3<span class="main">|</span>TEE_CS4<span class="main">|</span>TEEC_IC1<span class="main">|</span>TEEC_IC2<span class="main">|</span>TEEC_IC3<span class="main">|</span>TEEC_IC4<span class="main">|</span>TEEC_CS1<span class="main">|</span>TEEC_CS2<span class="main">|</span>TEEC_CS3<span class="main">|</span>TEEC_CS4
<span class="comment1">(*designed for exec_prime in s,  prime is a list of events which should be executed first,e.g.,after
OpenSession, a tuple was added, after EVENT_NAME execute successfully, that tuple was deleted*)</span>



<span class="comment1">(*Global system state of MiTEE*)</span>
<span class="keyword1"><span class="command">record</span></span> State <span class="main">=</span> 
        current <span class="main">::</span> <span class="quoted">DOMAIN_ID</span>
        TAs_state <span class="main">::</span> <span class="quoted">TAs_State</span>
        REE_state <span class="main">::</span> <span class="quoted">REE_TYPE</span>
        TEE_state <span class="main">::</span> <span class="quoted">TEE_TYPE</span>
        system_time <span class="main">::</span> <span class="quoted">SYSTIME</span>
        exec_prime <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>EVENT_PARAM <span class="main">×</span> EVENT_NAME<span class="main">)</span> list"</span></span>
<span class="comment1">(**)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</body></html>