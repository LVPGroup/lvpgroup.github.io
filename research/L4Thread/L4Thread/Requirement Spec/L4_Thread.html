<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><style>/* Isabelle fonts */

@font-face {
  font-family: 'Isabelle DejaVu Sans';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSans.ttf') format('truetype');
}

@font-face {
  font-family: 'Isabelle DejaVu Sans';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSans-Bold.ttf') format('truetype');
  font-weight: bold;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSans-Oblique.ttf') format('truetype');
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSans-BoldOblique.ttf') format('truetype');
  font-weight: bold;
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans Mono';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSansMono.ttf') format('truetype');
}

@font-face {
  font-family: 'Isabelle DejaVu Sans Mono';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSansMono-Bold.ttf') format('truetype');
  font-weight: bold;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans Mono';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSansMono-Oblique.ttf') format('truetype');
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Sans Mono';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSansMono-BoldOblique.ttf') format('truetype');
  font-weight: bold;
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Serif';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSerif.ttf') format('truetype');
}

@font-face {
  font-family: 'Isabelle DejaVu Serif';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSerif-Bold.ttf') format('truetype');
  font-weight: bold;
}

@font-face {
  font-family: 'Isabelle DejaVu Serif';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSerif-Italic.ttf') format('truetype');
  font-style: italic;
}

@font-face {
  font-family: 'Isabelle DejaVu Serif';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/IsabelleDejaVuSerif-BoldItalic.ttf') format('truetype');
  font-weight: bold;
  font-style: italic;
}

@font-face {
  font-family: 'Vacuous';
  src: url('/a6825305-9cdd-4ac5-b661-569d2fcf8cab/fonts/Vacuous.ttf') format('truetype');
}


/* standard document markup */

dt {
  float: left;
  clear: left;
  padding-right: 0.5em;
  font-weight: bold;
}

body {
  color: #000000;
  background-color: #FFFFFF;
}

.head     { background-color: #FFFFFF; }
.source   {
  direction: ltr; unicode-bidi: bidi-override;
  background-color: #FFFFFF;
  padding: 10px;
  font-family: "Isabelle DejaVu Sans Mono", monospace;
}

.theories { background-color: #FFFFFF; padding: 10px; }
.sessions { background-color: #FFFFFF; padding: 10px; }
.document { white-space: normal; font-family: "Isabelle DejaVu Serif", serif; }

.name     { font-style: italic; }
.filename { font-family: "Isabelle DejaVu Sans Mono", monospace; }


/* basic syntax markup */

.hidden         { font-family: Vacuous; font-size: 1%; color: rgba(255,255,255,0); }
.control        { font-weight: bold; font-style: italic; }

.binding        { color: #336655; }
.tfree          { color: #A020F0; }
.tvar           { color: #A020F0; }
.free           { color: #0000FF; }
.skolem         { color: #D2691E; }
.bound          { color: #008000; }
.var            { color: #00009B; }
.numeral        { }
.literal        { font-weight: bold; }
.delimiter      { }
.inner_numeral  { color: #FF0000; }
.inner_quoted   { color: #FF00CC; }
.inner_cartouche { color: #CC6600; }
.comment1       { color: #CC0000; }
.comment2       { color: #FF8400; }
.comment3       { color: #6600CC; }
.dynamic        { color: #7BA428; }
.class_parameter_color { color: #D2691E; }

.bold           { font-weight: bold; }

.main           { color: #000000; }
.command        { font-weight: bold; }
.keyword        { font-weight: bold; }
.keyword1       { color: #006699; }
.keyword2       { color: #009966; }
.keyword3       { color: #0099FF; }
.quasi_keyword  { color: #9966FF; }
.operator       { color: #323232; }
.string         { color: #FF00CC; }
.alt_string     { color: #CC00CC; }
.verbatim       { color: #6600CC; }
.cartouche      { color: #CC6600; }
.comment        { color: #CC0000; }
.improper       { color: #FF5050; }
.antiquote      { color: #6600CC; }
.raw_text       { color: #6600CC; }
.plain_text     { color: #CC6600; }
.bad            { background-color: #FF6A6A; }
.quoted         { background-color: rgba(139,139,139,0.05); }
.antiquoted     { background-color: rgba(255,200,50,0.1); }


/* message background */

.writeln_message      { background-color: #F0F0F0; }
.information_message  { background-color: #DCEAF3; }
.tracing_message      { background-color: #F0F8FF; }
.warning_message      { background-color: #EEE8AA; }
.legacy_message       { background-color: #EEE8AA; }
.error_message        { background-color: #FFC1C1; }


/* message underline */

.writeln { border-bottom: 1px dotted #C0C0C0; }
.information { border-bottom: 1px dotted #C1DFEE; }
.warning { border-bottom: 1px dotted #FF8C00; }
.legacy { border-bottom: 1px dotted #FF8C00; }
.error { border-bottom: 1px dotted #B22222; }


/* tooltips */

.writeln { position: relative; display: inline-block; }
.information { position: relative; display: inline-block; }
.warning { position: relative; display: inline-block; }
.legacy { position: relative; display: inline-block; }
.error { position: relative; display: inline-block; }

.writeln:hover .tooltip { visibility: visible; }
.information:hover .tooltip { visibility: visible; }
.warning:hover .tooltip { visibility: visible; }
.legacy:hover .tooltip { visibility: visible; }
.error:hover .tooltip { visibility: visible; }

.tooltip {
  top: -0.5ex;
  left: 5em;
  visibility: hidden;
  width: 50em;
  border: 1px solid #808080;
  padding: 1px 1px;
  background-color: #FFFFE9;
  position: absolute;
  z-index: 1;
}

.tooltip pre { margin: 1px; white-space: pre-wrap; }
</style><title>Theory "L4_Thread"</title></head>
<body><pre class="source"><span class="keyword1"><span class="command">theory</span></span> L4_Thread
<span class="keyword2"><span class="keyword">imports</span></span> L4_Space
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> isRunnable<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isRunnable</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsRunning<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> isSending<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isSending</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsPolling<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> isReceiving<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isReceiving</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsWaitingForever <span class="main">∨</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsWaitingTimeout<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> isAborted<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isAborted</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsAborted<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> isRunning<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isRunning</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsRunning<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> isWaiting<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isWaiting</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsWaitingForever <span class="main">∨</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsWaitingTimeout<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> isWaitingForever<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isWaitingForever</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsWaitingForever<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> isWaitingWithTimeout<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isWaitingWithTimeout</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsWaitingTimeout<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> isPolling<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadstate_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">isPolling</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span> <span class="main">=</span> tsPolling<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GLOBAL_GNO<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> threadid_t set"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span> 
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GLOBAL_GNO</span> <span class="free"><span class="bound">SysConf</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">tid</span><span class="main">.</span> <span class="main">∃</span><span class="bound">gid</span><span class="main">.</span> <span class="bound">tid</span> <span class="main">=</span> Global <span class="bound">gid</span> <span class="main">∧</span> <span class="bound">gid</span> <span class="main">∈</span> Threads_Gno <span class="free"><span class="bound">SysConf</span></span><span class="main">}</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GLOBAL_TID<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> threadid_t set"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GLOBAL_TID</span> <span class="free"><span class="bound">SysConf</span></span> <span class="main">=</span> GLOBAL_GNO <span class="free"><span class="bound">SysConf</span></span> <span class="main">∪</span> <span class="main">{</span>NILTHREAD<span class="main">,</span>ANYTHREAD<span class="main">}</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GnoToTid<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"globalid_t <span class="main">⇒</span> threadid_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GnoToTid</span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> Global <span class="free"><span class="bound">gno</span></span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GnosToTids<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"globalid_t set <span class="main">⇒</span> threadid_t set"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GnosToTids</span> <span class="free"><span class="bound">gnos</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">tid</span><span class="main">.</span> <span class="main">∃</span><span class="bound">gno</span><span class="main">.</span> <span class="bound">gno</span> <span class="main">∈</span> <span class="free"><span class="bound">gnos</span></span> <span class="main">∧</span> <span class="bound">tid</span> <span class="main">=</span> Global <span class="bound">gno</span><span class="main">}</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> TidsToGnos<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"threadid_t set <span class="main">⇒</span> globalid_t set"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">TidsToGnos</span> <span class="free"><span class="bound">tids</span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">gno</span><span class="main">.</span> <span class="main">∃</span><span class="bound">tid</span><span class="main">.</span> <span class="bound">tid</span> <span class="main">∈</span> <span class="free"><span class="bound">tids</span></span> <span class="main">∧</span> <span class="bound">tid</span> <span class="main">=</span> Global <span class="bound">gno</span><span class="main">}</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadsTids<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> threadid_t set"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadsTids</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> GnosToTids <span class="main">(</span>threads <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetActiveThreadsTids<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> threadid_t set"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetActiveThreadsTids</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> GnosToTids <span class="main">(</span>active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadScheduler<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadScheduler</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_scheduler <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadState<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadstate_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadState</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_state <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadPager<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadPager</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_pager <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadHandler<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadHandler</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_handler <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadMessage<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> message_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadMessage</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_message <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadRcvWindow<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> fpage_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadRcvWindow</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_rcvWindow <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadPriority <span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> nat"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadPriority</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_priority <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadQuantum <span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> int"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadQuantum</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span><span class="main">(</span>the <span class="main">(</span>thread_total_quantum <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadTimeslice <span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> int"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadTimeslice</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_timeslice_length <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadCurrentTimeslice <span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> int"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadCurrentTimeslice</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_current_timeslice <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadSpace<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadSpace</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetCurrentSpace<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> spaceName_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetCurrentSpace</span> <span class="free"><span class="bound">s</span></span> <span class="main">=</span> GetThreadSpace <span class="free"><span class="bound">s</span></span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="comment1">(*"GetSpaceThreads s sp = {t. ∃t. thread_space s t = Some sp}"*)</span>
<span class="keyword1"><span class="command">definition</span></span> GetSpaceThreads<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t set"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetSpaceThreads</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">sp</span></span> <span class="main">=</span> the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">sp</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetSpaceThreadsNums<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> nat"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetSpaceThreadsNums</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">sp</span></span> <span class="main">=</span> card <span class="main">(</span>GetSpaceThreads <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">sp</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetCurrentThread<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetCurrentThread</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>current_thread<span class="main">:=</span> <span class="free"><span class="bound">t</span></span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadsAdd<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadsAdd</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>threads<span class="main">:=</span><span class="main">(</span>threads <span class="free"><span class="bound">s</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">t</span></span><span class="main">}</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadsDel<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadsDel</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>threads<span class="main">:=</span><span class="main">(</span>threads <span class="free"><span class="bound">s</span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound">t</span></span><span class="main">}</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetActiveAdd<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetActiveAdd</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>active_threads<span class="main">:=</span><span class="main">(</span>active_threads <span class="free"><span class="bound">s</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">t</span></span><span class="main">}</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetActiveDel<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetActiveDel</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>active_threads<span class="main">:=</span><span class="main">(</span>active_threads <span class="free"><span class="bound">s</span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound">t</span></span><span class="main">}</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadSpace<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadSpace</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">sp</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_space<span class="main">:=</span><span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">sp</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadScheduler<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadScheduler</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">sche</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_scheduler<span class="main">:=</span><span class="main">(</span>thread_scheduler <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">sche</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadState<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadstate_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadState</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">ts</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_state<span class="main">:=</span><span class="main">(</span>thread_state <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">ts</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadPager<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadPager</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">p</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_pager<span class="main">:=</span><span class="main">(</span>thread_pager <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">p</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadHandler<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadHandler</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">p</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_handler<span class="main">:=</span><span class="main">(</span>thread_pager <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">p</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadMessage<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> message_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadMessage</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">msg</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_message<span class="main">:=</span><span class="main">(</span>thread_message <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">msg</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadRcvWindow<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> fpage_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadRcvWindow</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">fpage</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_rcvWindow<span class="main">:=</span><span class="main">(</span>thread_rcvWindow <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">fpage</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadPriority <span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> nat <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadPriority</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">prio</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span> <span class="main">⦇</span>thread_priority<span class="main">:=</span><span class="main">(</span>thread_priority <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">prio</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadQuantum <span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> int <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadQuantum</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">quan</span></span> <span class="main">=</span>
 <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_total_quantum<span class="main">:=</span><span class="main">(</span>thread_total_quantum <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">quan</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadTimeslice <span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> int <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadTimeslice</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">timeslice</span></span><span class="main">=</span>
 <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_timeslice_length<span class="main">:=</span><span class="main">(</span>thread_timeslice_length <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">timeslice</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadCurrentTimeslice <span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> int <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadCurrentTimeslice</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">timeslice</span></span> <span class="main">=</span>
 <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_current_timeslice<span class="main">:=</span><span class="main">(</span>thread_current_timeslice <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">timeslice</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetSpaceThreadsAdd<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetSpaceThreadsAdd</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">sp</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> 
    <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>space_threads<span class="main">:=</span><span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">sp</span></span><span class="main">:=</span> Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">sp</span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">t</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetSpaceThreadsDel<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetSpaceThreadsDel</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">sp</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> 
    <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>space_threads<span class="main">:=</span><span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">sp</span></span><span class="main">:=</span> Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">sp</span></span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound">t</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetIpcPartner<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetIpcPartner</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_ipc_partner <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetIpcPartner<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetIpcPartner</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> 
<span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_ipc_partner<span class="main">:=</span> <span class="main">(</span>thread_ipc_partner <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">gno</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetIpcTimeout<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> timeout_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetIpcTimeout</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_ipc_timeout <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetIpcTimeout<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> timeout_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetIpcTimeout</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">timeout</span></span> <span class="main">=</span> 
<span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_ipc_timeout<span class="main">:=</span> <span class="main">(</span>thread_ipc_timeout <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="main">(</span>eFiniteTimeout <span class="main">(</span><span class="main">(</span>GetTimeout <span class="free"><span class="bound">timeout</span></span><span class="main">)</span> <span class="main">+</span> current_time <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetRecvFor<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetRecvFor</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_recv_for <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetRecvFor<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetRecvFor</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> 
<span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_recv_for<span class="main">:=</span> <span class="main">(</span>thread_recv_for <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">gno</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetRecvTimeout<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> timeout_t"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetRecvTimeout</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_recv_timeout <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetRecvTimeout<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> timeout_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetRecvTimeout</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">timeout</span></span> <span class="main">=</span> 
<span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_recv_timeout<span class="main">:=</span> <span class="main">(</span>thread_recv_timeout <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">timeout</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadsIncoming<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t list"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadsIncoming</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> the <span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadsIncoming<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t list <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadsIncoming</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">ts</span></span> <span class="main">=</span> 
<span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_incoming<span class="main">:=</span><span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span>Some <span class="free"><span class="bound">ts</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadsIncomingAdd<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadsIncomingAdd</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">=</span> 
<span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_incoming<span class="main">:=</span><span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span> Some <span class="main">(</span>the <span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound">gno</span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetThreadsIncomingDel<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetThreadsIncomingDel</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">=</span> 
<span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_incoming<span class="main">:=</span><span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">:=</span> Some <span class="main">(</span>remove1 <span class="free"><span class="bound">gno</span></span> <span class="main">(</span>the <span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> GetThreadsIncomingTids<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadid_t list"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">GetThreadsIncomingTids</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span> <span class="main">=</span> map GnoToTid <span class="main">(</span>the <span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">t</span></span><span class="main">)</span><span class="main">)</span>"</span></span></span>


<span class="comment1">―<span class="quoted"><span class="document"><span class="plain_text">‹Scheduling›</span></span></span></span>
<span class="keyword1"><span class="command">definition</span></span> ExistInList <span class="main">::</span> <span class="quoted"><span class="quoted"><span class="language">"globalid_t <span class="main">⇒</span> globalid_t list <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">ExistInList</span> <span class="free"><span class="bound">t</span></span> <span class="free"><span class="bound">ts</span></span> <span class="main">≡</span> find <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound">t</span></span><span class="main">)</span> <span class="free"><span class="bound">ts</span></span> <span class="main">≠</span> None"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> dequeue_ready_queuing <span class="main">::</span> <span class="quoted"><span class="quoted"><span class="language">"<span class="main">(</span>prio <span class="main">⇒</span> globalid_t list<span class="main">)</span> <span class="main">⇒</span> prio <span class="main">⇒</span> globalid_t <span class="main">⇒</span> <span class="main">(</span>prio <span class="main">⇒</span> globalid_t list<span class="main">)</span>"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">dequeue_ready_queuing</span> <span class="free"><span class="bound">queue</span></span> <span class="free"><span class="bound">prio</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> <span class="free"><span class="bound">queue</span></span><span class="main">(</span><span class="free"><span class="bound">prio</span></span><span class="main">:=</span> remove1 <span class="free"><span class="bound">gno</span></span> <span class="main">(</span><span class="free"><span class="bound">queue</span></span> <span class="free"><span class="bound">prio</span></span><span class="main">)</span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> dequeue_ready<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">dequeue_ready</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span>
<span class="main">(</span><span class="keyword1">let</span> <span class="bound">prio</span> <span class="main">=</span> GetThreadPriority <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">;</span>
     <span class="bound">old_queue</span> <span class="main">=</span> ready_queuing <span class="free"><span class="bound">s</span></span>
<span class="keyword1">in</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>ready_queuing<span class="main">:=</span> dequeue_ready_queuing <span class="bound">old_queue</span> <span class="bound">prio</span> <span class="free"><span class="bound">gno</span></span><span class="main">⦈</span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> enqueue_ready_queuing <span class="main">::</span> <span class="quoted"><span class="quoted"><span class="language">"<span class="main">(</span>prio <span class="main">⇒</span> globalid_t list<span class="main">)</span> <span class="main">⇒</span> prio <span class="main">⇒</span> globalid_t <span class="main">⇒</span> <span class="main">(</span>prio <span class="main">⇒</span> globalid_t list<span class="main">)</span>"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">enqueue_ready_queuing</span> <span class="free"><span class="bound">queue</span></span> <span class="free"><span class="bound">prio</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> <span class="free"><span class="bound">queue</span></span><span class="main">(</span><span class="free"><span class="bound">prio</span></span><span class="main">:=</span> <span class="free"><span class="bound">gno</span></span> <span class="main">#</span> <span class="free"><span class="bound">queue</span></span> <span class="free"><span class="bound">prio</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> enqueue_ready<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">enqueue_ready</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">let</span> <span class="bound">prio</span> <span class="main">=</span> GetThreadPriority <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">;</span>
     <span class="bound">old_queue</span> <span class="main">=</span> ready_queuing <span class="free"><span class="bound">s</span></span>
<span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>find <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span> <span class="main">(</span><span class="bound">old_queue</span> <span class="bound">prio</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span> 
    <span class="keyword1">then</span> <span class="free"><span class="bound">s</span></span> 
    <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>ready_queuing<span class="main">:=</span> enqueue_ready_queuing <span class="bound">old_queue</span> <span class="bound">prio</span> <span class="free"><span class="bound">gno</span></span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">fun</span></span> enqueue_readys<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t list <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">enqueue_readys</span> <span class="free"><span class="bound">s</span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span>"</span></span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">enqueue_readys</span> <span class="free"><span class="bound">s</span></span> <span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">#</span><span class="free"><span class="bound">ts</span></span><span class="main">)</span> <span class="main">=</span> enqueue_ready <span class="main">(</span><span class="free">enqueue_readys</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">ts</span></span><span class="main">)</span> <span class="free"><span class="bound">t</span></span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> dequeue_wait<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">dequeue_wait</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>wait_queuing<span class="main">:=</span> remove1 <span class="free"><span class="bound">gno</span></span> <span class="main">(</span>wait_queuing <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> enqueue_wait<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">enqueue_wait</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>find <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span> <span class="main">(</span>wait_queuing <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span> 
                       <span class="keyword1">then</span> <span class="free"><span class="bound">s</span></span> 
                       <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>wait_queuing<span class="main">:=</span> <span class="free"><span class="bound">gno</span></span> <span class="main">#</span> wait_queuing <span class="free"><span class="bound">s</span></span><span class="main">⦈</span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">fun</span></span> dequeue_waits<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t list <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">dequeue_waits</span> <span class="free"><span class="bound">s</span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span>"</span></span></span><span class="main">|</span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">dequeue_waits</span> <span class="free"><span class="bound">s</span></span> <span class="main">(</span><span class="free"><span class="bound">t</span></span><span class="main">#</span><span class="free"><span class="bound">ts</span></span><span class="main">)</span> <span class="main">=</span> dequeue_wait <span class="main">(</span><span class="free">dequeue_waits</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">ts</span></span><span class="main">)</span> <span class="free"><span class="bound">t</span></span>"</span></span></span>

<span class="comment1">―<span class="quoted"><span class="document"><span class="plain_text">‹Thread Operations›</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> CreateThread_Cond<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">CreateThread_Cond</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="main">≡</span> 
    <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> Threads_Gno <span class="free"><span class="bound">SysConf</span></span> <span class="main">-</span> threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound">scheduler</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">∈</span> Address_Space <span class="free"><span class="bound">SysConf</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">≠</span> KernelSpace<span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">∈</span> spaces <span class="free"><span class="bound">s</span></span> <span class="main">⟶</span> GetSpaceThreadsNums <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">space</span></span> <span class="main">&lt;</span> MaxThreadsPerSpace <span class="free"><span class="bound">SysConf</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">≠</span> idle<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> CreateThread<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">CreateThread</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> CreateThread_Cond <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound">space</span></span> <span class="main">∉</span> spaces <span class="free"><span class="bound">s</span></span>
                <span class="keyword1">then</span> CreateAddressSpace <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">space</span></span> 
                <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">;</span>
          <span class="bound">S''</span> <span class="main">=</span> <span class="bound">S'</span><span class="main">⦇</span>space_threads<span class="main">:=</span><span class="main">(</span>space_threads <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">space</span></span><span class="main">:=</span>Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="bound">S'</span> <span class="free"><span class="bound">space</span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                   threads <span class="main">:=</span> threads <span class="bound">S'</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
                   thread_space <span class="main">:=</span> <span class="main">(</span>thread_space <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="free"><span class="bound">space</span></span><span class="main">)</span><span class="main">,</span>
                   thread_scheduler <span class="main">:=</span> <span class="main">(</span>thread_scheduler <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="free"><span class="bound">scheduler</span></span><span class="main">)</span><span class="main">,</span>
                   thread_state <span class="main">:=</span> <span class="main">(</span>thread_state <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some tsAborted<span class="main">)</span><span class="main">,</span>
                   thread_total_quantum <span class="main">:=</span>  <span class="main">(</span>thread_total_quantum <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TOTAL_QUANTUM<span class="main">)</span><span class="main">,</span>
                   thread_timeslice_length <span class="main">:=</span>  <span class="main">(</span>thread_timeslice_length <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TIMESLICE_LENGTH<span class="main">)</span><span class="main">,</span>
                   thread_current_timeslice <span class="main">:=</span>  <span class="main">(</span>thread_current_timeslice <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TIMESLICE_LENGTH<span class="main">)</span><span class="main">,</span>
                   thread_priority <span class="main">:=</span>  <span class="main">(</span>thread_priority <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_PRIORITY<span class="main">)</span><span class="main">,</span>
                   thread_ipc_partner <span class="main">:=</span> <span class="main">(</span>thread_ipc_partner <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some NILTHREAD<span class="main">)</span><span class="main">,</span>
                   thread_ipc_timeout <span class="main">:=</span> <span class="main">(</span>thread_ipc_timeout <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some eInfiniteTimeout<span class="main">)</span><span class="main">,</span>
                   thread_incoming <span class="main">:=</span> <span class="main">(</span>thread_incoming <span class="bound">S'</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">[]</span><span class="main">)</span><span class="main">⦈</span>
       <span class="keyword1">in</span> SetError <span class="bound">S''</span> <span class="main">(</span>current_thread <span class="bound">S''</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>


<span class="keyword1"><span class="command">definition</span></span> CreateTcb<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">CreateTcb</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="main">=</span> 
     <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>space_threads<span class="main">:=</span><span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">:=</span> Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">space</span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       threads <span class="main">:=</span> threads <span class="free"><span class="bound">s</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
       thread_space <span class="main">:=</span> <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="free"><span class="bound">space</span></span><span class="main">)</span><span class="main">,</span>
       thread_scheduler <span class="main">:=</span> <span class="main">(</span>thread_scheduler <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="free"><span class="bound">scheduler</span></span><span class="main">)</span><span class="main">,</span>
       thread_state <span class="main">:=</span> <span class="main">(</span>thread_state <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some tsAborted<span class="main">)</span><span class="main">,</span>
       thread_total_quantum <span class="main">:=</span>  <span class="main">(</span>thread_total_quantum <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TOTAL_QUANTUM<span class="main">)</span><span class="main">,</span>
       thread_timeslice_length <span class="main">:=</span>  <span class="main">(</span>thread_timeslice_length <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TIMESLICE_LENGTH<span class="main">)</span><span class="main">,</span>
       thread_current_timeslice <span class="main">:=</span>  <span class="main">(</span>thread_current_timeslice <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TIMESLICE_LENGTH<span class="main">)</span><span class="main">,</span>
       thread_priority <span class="main">:=</span>  <span class="main">(</span>thread_priority <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_PRIORITY<span class="main">)</span><span class="main">,</span>
       thread_ipc_partner <span class="main">:=</span> <span class="main">(</span>thread_ipc_partner <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some NILTHREAD<span class="main">)</span><span class="main">,</span>
       thread_ipc_timeout <span class="main">:=</span> <span class="main">(</span>thread_ipc_timeout <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some eInfiniteTimeout<span class="main">)</span><span class="main">,</span>
       thread_incoming <span class="main">:=</span> <span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">[]</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> CreateThread'<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">CreateThread'</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> CreateThread_Cond <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound">space</span></span> <span class="main">∉</span> spaces <span class="free"><span class="bound">s</span></span>
                <span class="keyword1">then</span> CreateAddressSpace <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">space</span></span> 
                <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="keyword1">in</span> 
      <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> CreateTcb <span class="bound">s1</span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="keyword1">in</span> 
          SetError <span class="bound">s2</span> <span class="main">(</span>current_thread <span class="bound">s2</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> CreateThread_eq<span class="main">:</span><span class="quoted"><span class="quoted"><span class="language">"CreateThread <span class="main">=</span> CreateThread'"</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CreateThread'_def CreateThread_def CreateTcb_def
  <span class="keyword1"><span class="command">by</span></span> <span class="language"><span class="operator">simp</span></span>

<span class="keyword1"><span class="command">definition</span></span> ActivateThread<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">ActivateThread</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">S</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">pager</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">S</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">S</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∉</span> active_threads <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound">pager</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">S</span></span><span class="main">)</span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S'</span> <span class="main">=</span> <span class="free"><span class="bound">S</span></span><span class="main">⦇</span>
        active_threads <span class="main">:=</span> active_threads <span class="free"><span class="bound">S</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
        thread_state <span class="main">:=</span> <span class="main">(</span>thread_state <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some tsWaitingForever<span class="main">)</span><span class="main">,</span>
        thread_pager <span class="main">:=</span> <span class="main">(</span>thread_pager <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>Global <span class="free"><span class="bound">pager</span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        thread_handler <span class="main">:=</span> <span class="main">(</span>thread_handler <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some NILTHREAD<span class="main">)</span><span class="main">,</span>
        thread_message <span class="main">:=</span> <span class="main">(</span>thread_message <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>UNTYPED <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        thread_rcvWindow <span class="main">:=</span> <span class="main">(</span>thread_rcvWindow <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>        
        thread_error <span class="main">:=</span> <span class="main">(</span>thread_error <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some eNoError<span class="main">)</span><span class="main">,</span>
        thread_ipc_partner <span class="main">:=</span> <span class="main">(</span>thread_ipc_partner <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>Global <span class="free"><span class="bound">pager</span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        thread_ipc_timeout <span class="main">:=</span> <span class="main">(</span>thread_ipc_timeout <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some eInfiniteTimeout<span class="main">)</span><span class="main">⦈</span>
      <span class="keyword1">in</span> SetError <span class="bound">S'</span> <span class="main">(</span>current_thread <span class="bound">S'</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">S</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> CreateActiveThread_Cond<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">CreateActiveThread_Cond</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">S</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="free"><span class="bound">pager</span></span> <span class="main">≡</span>
    <span class="main">(</span>current_thread <span class="free"><span class="bound">S</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">S</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> <span class="main">(</span>Threads_Gno <span class="free"><span class="bound">SysConf</span></span> <span class="main">-</span> threads <span class="free"><span class="bound">S</span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound">scheduler</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">scheduler</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">∈</span> initialised_spaces <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">pager</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">≠</span> KernelSpace<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>GetSpaceThreadsNums <span class="free"><span class="bound">S</span></span> <span class="free"><span class="bound">space</span></span> <span class="main">&lt;</span> MaxThreadsPerSpace <span class="free"><span class="bound">SysConf</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">≠</span> idle<span class="main">)</span>"</span></span></span>


<span class="keyword1"><span class="command">definition</span></span> CreateActiveThread<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">CreateActiveThread</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="free"><span class="bound">pager</span></span> <span class="main">=</span>
<span class="main">(</span><span class="keyword1">if</span> CreateActiveThread_Cond <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="free"><span class="bound">pager</span></span>
 <span class="keyword1">then</span> 
   <span class="keyword1">let</span> <span class="bound">S'</span> <span class="main">=</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>space_threads<span class="main">:=</span><span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">space</span></span><span class="main">:=</span>Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">space</span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
             threads <span class="main">:=</span> threads <span class="free"><span class="bound">s</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
             active_threads <span class="main">:=</span> active_threads <span class="free"><span class="bound">s</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
             thread_space <span class="main">:=</span> <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="free"><span class="bound">space</span></span><span class="main">)</span><span class="main">,</span>
             thread_scheduler <span class="main">:=</span> <span class="main">(</span>thread_scheduler <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="free"><span class="bound">scheduler</span></span><span class="main">)</span><span class="main">,</span>
             thread_state <span class="main">:=</span> <span class="main">(</span>thread_state <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some tsWaitingForever<span class="main">)</span><span class="main">,</span>
             thread_pager <span class="main">:=</span> <span class="main">(</span>thread_pager <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>Global <span class="free"><span class="bound">pager</span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
             thread_handler <span class="main">:=</span> <span class="main">(</span>thread_handler <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some NILTHREAD<span class="main">)</span><span class="main">,</span>
             thread_message <span class="main">:=</span> <span class="main">(</span>thread_message <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>UNTYPED <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
             thread_rcvWindow <span class="main">:=</span> <span class="main">(</span>thread_rcvWindow <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>        
             thread_error <span class="main">:=</span> <span class="main">(</span>thread_error <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some eNoError<span class="main">)</span><span class="main">,</span>
             thread_total_quantum <span class="main">:=</span> <span class="main">(</span>thread_total_quantum <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TOTAL_QUANTUM<span class="main">)</span><span class="main">,</span>
             thread_timeslice_length <span class="main">:=</span> <span class="main">(</span>thread_timeslice_length <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TIMESLICE_LENGTH<span class="main">)</span><span class="main">,</span>
             thread_current_timeslice <span class="main">:=</span>  <span class="main">(</span>thread_current_timeslice <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TIMESLICE_LENGTH<span class="main">)</span><span class="main">,</span>
             thread_priority <span class="main">:=</span>  <span class="main">(</span>thread_priority <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_PRIORITY<span class="main">)</span><span class="main">,</span>
             thread_ipc_partner <span class="main">:=</span> <span class="main">(</span>thread_ipc_partner <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>Global <span class="free"><span class="bound">pager</span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
             thread_ipc_timeout <span class="main">:=</span> <span class="main">(</span>thread_ipc_timeout <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some eInfiniteTimeout<span class="main">)</span><span class="main">,</span>
             thread_incoming <span class="main">:=</span> <span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">[]</span><span class="main">)</span><span class="main">⦈</span>
    <span class="keyword1">in</span> SetError <span class="bound">S'</span> <span class="main">(</span>current_thread <span class="bound">S'</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> CreateActiveTcb<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">CreateActiveTcb</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="free"><span class="bound">pager</span></span> <span class="main">=</span> 
    <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>space_threads<span class="main">:=</span><span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">space</span></span><span class="main">:=</span>Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">space</span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     threads <span class="main">:=</span> threads <span class="free"><span class="bound">s</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
     active_threads <span class="main">:=</span> active_threads <span class="free"><span class="bound">s</span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
     thread_space <span class="main">:=</span> <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="free"><span class="bound">space</span></span><span class="main">)</span><span class="main">,</span>
     thread_scheduler <span class="main">:=</span> <span class="main">(</span>thread_scheduler <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="free"><span class="bound">scheduler</span></span><span class="main">)</span><span class="main">,</span>
     thread_state <span class="main">:=</span> <span class="main">(</span>thread_state <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some tsWaitingForever<span class="main">)</span><span class="main">,</span>
     thread_pager <span class="main">:=</span> <span class="main">(</span>thread_pager <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>Global <span class="free"><span class="bound">pager</span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     thread_handler <span class="main">:=</span> <span class="main">(</span>thread_handler <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some NILTHREAD<span class="main">)</span><span class="main">,</span>
     thread_message <span class="main">:=</span> <span class="main">(</span>thread_message <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>UNTYPED <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     thread_rcvWindow <span class="main">:=</span> <span class="main">(</span>thread_rcvWindow <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     thread_error <span class="main">:=</span> <span class="main">(</span>thread_error <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some eNoError<span class="main">)</span><span class="main">,</span>
     thread_total_quantum <span class="main">:=</span> <span class="main">(</span>thread_total_quantum <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TOTAL_QUANTUM<span class="main">)</span><span class="main">,</span>
     thread_timeslice_length <span class="main">:=</span> <span class="main">(</span>thread_timeslice_length <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TIMESLICE_LENGTH<span class="main">)</span><span class="main">,</span>
     thread_current_timeslice <span class="main">:=</span>  <span class="main">(</span>thread_current_timeslice <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_TIMESLICE_LENGTH<span class="main">)</span><span class="main">,</span>
     thread_priority <span class="main">:=</span>  <span class="main">(</span>thread_priority <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some DEFAULT_PRIORITY<span class="main">)</span><span class="main">,</span>
     thread_ipc_partner <span class="main">:=</span> <span class="main">(</span>thread_ipc_partner <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">(</span>Global <span class="free"><span class="bound">pager</span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     thread_ipc_timeout <span class="main">:=</span> <span class="main">(</span>thread_ipc_timeout <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some eInfiniteTimeout<span class="main">)</span><span class="main">,</span>
     thread_incoming <span class="main">:=</span> <span class="main">(</span>thread_incoming <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> Some <span class="main">[]</span><span class="main">)</span><span class="main">⦈</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> CreateActiveThread'<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">CreateActiveThread'</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="free"><span class="bound">pager</span></span> <span class="main">=</span>
<span class="main">(</span><span class="keyword1">if</span> CreateActiveThread_Cond <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="free"><span class="bound">pager</span></span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">s'</span> <span class="main">=</span> CreateActiveTcb <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="free"><span class="bound">pager</span></span>
       <span class="keyword1">in</span> SetError <span class="bound">s'</span> <span class="main">(</span>current_thread <span class="bound">s'</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> CreateActiveThread_eq<span class="main">:</span><span class="quoted"><span class="quoted"><span class="language">"CreateActiveThread' <span class="main">=</span> CreateActiveThread"</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CreateActiveTcb_def CreateActiveThread'_def CreateActiveThread_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="language"><span class="operator">simp</span></span>
<span class="comment1">(*
definition Unwind::"State ⇒ globalid_t ⇒ State" where
"Unwind s gno = 
(if gno ∈ active_threads s
 then 
  (let state = (GetThreadState s gno);
       partner = (GetIpcPartner s gno)
    in (if isPolling state ∧ partner ≠ NILTHREAD ∧ partner ≠ ANYTHREAD
        then 
          let S1 = dequeue_wait s gno
           in SetThreadsIncomingDel S1 (TidToGno partner) gno
        else dequeue_wait s gno))
 else s)"
*)</span>
<span class="keyword1"><span class="command">definition</span></span> Unwind<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">Unwind</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span>
 <span class="keyword1">then</span> 
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">state</span> <span class="main">=</span> <span class="main">(</span>GetThreadState <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span><span class="main">;</span>
       <span class="bound">partner</span> <span class="main">=</span> <span class="main">(</span>GetIpcPartner <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> isPolling <span class="bound">state</span> <span class="main">∧</span> <span class="bound">partner</span> <span class="main">≠</span> NILTHREAD <span class="main">∧</span> <span class="bound">partner</span> <span class="main">≠</span> ANYTHREAD
        <span class="keyword1">then</span> 
          <span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> dequeue_wait <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span>
           <span class="keyword1">in</span> SetThreadsIncomingDel <span class="bound">S1</span> <span class="main">(</span>TidToGno <span class="bound">partner</span><span class="main">)</span> <span class="free"><span class="bound">gno</span></span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> isWaiting <span class="bound">state</span> <span class="main">∧</span> <span class="bound">partner</span> <span class="main">≠</span> NILTHREAD 
             <span class="keyword1">then</span> dequeue_wait <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span>
             <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">)</span>
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> DeleteThread_Cond<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">DeleteThread_Cond</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">≡</span>
    <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">≠</span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">≠</span> Some Sigma0Space<span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">≠</span> Some RootServerSpace<span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">≠</span> Some KernelSpace<span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> DeleteThread<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">DeleteThread</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span>
<span class="main">(</span><span class="keyword1">if</span> DeleteThread_Cond <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">s2</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span>
               <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">s1</span> <span class="main">=</span> dequeue_ready <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span>
                    <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> isSending <span class="main">(</span>the <span class="main">(</span>thread_state <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> 
                           isReceiving <span class="main">(</span>the <span class="main">(</span>thread_state <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span><span class="main">)</span>
                        <span class="keyword1">then</span> Unwind <span class="bound">s1</span> <span class="free"><span class="bound">gno</span></span>
                        <span class="keyword1">else</span> <span class="bound">s1</span><span class="main">)</span>
               <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">;</span>
          <span class="bound">space</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span>thread_space <span class="bound">s2</span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">s4</span> <span class="main">=</span> <span class="keyword1">if</span> the <span class="main">(</span>space_threads <span class="bound">s2</span> <span class="bound">space</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span>
               <span class="keyword1">then</span> DeleteAddressSpace <span class="bound">s2</span> <span class="bound">space</span>
               <span class="keyword1">else</span> <span class="bound">s2</span><span class="main">⦇</span>space_threads<span class="main">:=</span> <span class="main">(</span>space_threads <span class="bound">s2</span><span class="main">)</span>
                      <span class="main">(</span><span class="bound">space</span><span class="main">:=</span> Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="bound">s2</span> <span class="bound">space</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span><span class="main">;</span>        
          <span class="bound">s5</span> <span class="main">=</span> <span class="bound">s4</span><span class="main">⦇</span>threads <span class="main">:=</span> threads <span class="bound">s4</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
                 active_threads <span class="main">:=</span> active_threads <span class="bound">s4</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">,</span>
                 thread_space <span class="main">:=</span> <span class="main">(</span><span class="main">(</span>thread_space <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 thread_scheduler <span class="main">:=</span> <span class="main">(</span><span class="main">(</span>thread_scheduler <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 thread_state <span class="main">:=</span> <span class="main">(</span><span class="main">(</span>thread_state <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 thread_pager <span class="main">:=</span> <span class="main">(</span><span class="main">(</span>thread_pager <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">,</span>
                 thread_handler <span class="main">:=</span> <span class="main">(</span>thread_handler <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_message <span class="main">:=</span> <span class="main">(</span>thread_message <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_rcvWindow <span class="main">:=</span> <span class="main">(</span>thread_rcvWindow <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>             
                 thread_error <span class="main">:=</span> <span class="main">(</span>thread_error <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_priority <span class="main">:=</span> <span class="main">(</span>thread_priority <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_total_quantum <span class="main">:=</span> <span class="main">(</span>thread_total_quantum <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_timeslice_length <span class="main">:=</span> <span class="main">(</span>thread_timeslice_length <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_current_timeslice <span class="main">:=</span> <span class="main">(</span>thread_current_timeslice <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_ipc_partner <span class="main">:=</span> <span class="main">(</span>thread_ipc_partner <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_ipc_timeout <span class="main">:=</span> <span class="main">(</span>thread_ipc_timeout <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_recv_for <span class="main">:=</span> <span class="main">(</span>thread_recv_for <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_recv_timeout <span class="main">:=</span> <span class="main">(</span>thread_recv_timeout <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">,</span>
                 thread_incoming <span class="main">:=</span> <span class="main">(</span>thread_incoming <span class="bound">s4</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span><span class="main">:=</span> None<span class="main">)</span><span class="main">⦈</span>
      <span class="keyword1">in</span> SetError <span class="bound">s5</span> <span class="main">(</span>current_thread <span class="bound">s5</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetScheduler<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetScheduler</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">scheduler</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">scheduler</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">s</span></span><span class="main">)</span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> SetThreadScheduler <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">scheduler</span></span> 
       <span class="keyword1">in</span> SetError <span class="bound">S1</span> <span class="main">(</span>current_thread <span class="bound">S1</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetPager<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetPager</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">pager</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> 
<span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">pager</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">s</span></span><span class="main">)</span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> SetThreadPager <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">(</span>Global <span class="free"><span class="bound">pager</span></span><span class="main">)</span> 
       <span class="keyword1">in</span> SetError <span class="bound">S1</span> <span class="main">(</span>current_thread <span class="bound">S1</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> SetState<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadstate_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">SetState</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">state</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">state</span></span> <span class="main">≠</span> tsAborted<span class="main">)</span> <span class="main">∧</span>
 <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">≠</span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> SetThreadState <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">state</span></span> <span class="keyword1">in</span> SetError <span class="bound">S1</span> <span class="main">(</span>current_thread <span class="bound">S1</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> Migrate_Cond<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> bool"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">Migrate_Cond</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="main">≡</span>
    <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">s</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">∈</span> spaces <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">≠</span> the <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">≠</span> kSigma0<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">≠</span> kRootServer<span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">≠</span> Sigma0Space<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">≠</span> RootServerSpace<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">space</span></span> <span class="main">≠</span> KernelSpace<span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>GetSpaceThreadsNums <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">space</span></span> <span class="main">&lt;</span> MaxThreadsPerSpace <span class="free"><span class="bound">SysConf</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> Migrate<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> spaceName_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">Migrate</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span> <span class="main">=</span>
<span class="main">(</span><span class="keyword1">if</span> Migrate_Cond <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">space</span></span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S2</span> <span class="main">=</span> <span class="main">(</span>
            <span class="keyword1">let</span> <span class="bound">oldspace</span> <span class="main">=</span> the <span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span>
            <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="main">(</span>the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="bound">oldspace</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span>
               <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> DeleteAddressSpace <span class="free"><span class="bound">s</span></span> <span class="bound">oldspace</span>
                     <span class="keyword1">in</span> <span class="bound">S1</span><span class="main">⦇</span>thread_space <span class="main">:=</span> <span class="main">(</span><span class="main">(</span>thread_space <span class="bound">S1</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> Some <span class="free"><span class="bound">space</span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                          space_threads <span class="main">:=</span> <span class="main">(</span>space_threads <span class="bound">S1</span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">space</span></span><span class="main">:=</span> Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="bound">S1</span> <span class="free"><span class="bound">space</span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
               <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">⦇</span>thread_space <span class="main">:=</span> <span class="main">(</span><span class="main">(</span>thread_space <span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">:=</span> Some <span class="free"><span class="bound">space</span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
                      space_threads <span class="main">:=</span> <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span>
                        <span class="main">(</span><span class="free"><span class="bound">space</span></span><span class="main">:=</span> Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">space</span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">)</span><span class="main">,</span>
                         <span class="bound">oldspace</span><span class="main">:=</span> Some <span class="main">(</span>the <span class="main">(</span>space_threads <span class="free"><span class="bound">s</span></span> <span class="bound">oldspace</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound">gno</span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">⦈</span>
       <span class="main">)</span>
       <span class="keyword1">in</span> SetError <span class="bound">S2</span> <span class="main">(</span>current_thread <span class="bound">S2</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> ActivateInterrupt<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"Sys_Config <span class="main">⇒</span> State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">ActivateInterrupt</span> <span class="free"><span class="bound">SysConf</span></span> <span class="free"><span class="bound">S</span></span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">handler</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">S</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">S</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="free"><span class="bound">handler</span></span> <span class="main">∈</span> Threads_Gno <span class="free"><span class="bound">SysConf</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">handler</span></span> <span class="main">≠</span> <span class="free"><span class="bound">gno</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">handler</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">S</span></span><span class="main">)</span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> SetThreadScheduler <span class="main">(</span>SetThreadState <span class="free"><span class="bound">S</span></span> <span class="free"><span class="bound">gno</span></span> tsHalted<span class="main">)</span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">handler</span></span>
       <span class="keyword1">in</span> SetError <span class="bound">S1</span> <span class="main">(</span>current_thread <span class="bound">S1</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">S</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> DeactivateInterrupt<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">DeactivateInterrupt</span> <span class="free"><span class="bound">S</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">S</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">S</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>current_thread <span class="free"><span class="bound">S</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> kIntThreads<span class="main">)</span>
 <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> SetThreadScheduler <span class="main">(</span>SetThreadState <span class="free"><span class="bound">S</span></span> <span class="free"><span class="bound">gno</span></span> tsAborted<span class="main">)</span> <span class="free"><span class="bound">gno</span></span> <span class="free"><span class="bound">gno</span></span>
       <span class="keyword1">in</span> SetError <span class="bound">S1</span> <span class="main">(</span>current_thread <span class="bound">S1</span><span class="main">)</span> eNoError
 <span class="keyword1">else</span> <span class="free"><span class="bound">S</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> UnWait<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">UnWait</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> threads <span class="free"><span class="bound">s</span></span>
 <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">gno</span></span> <span class="main">∉</span> kIntThreads<span class="main">)</span>
       <span class="keyword1">then</span> SetThreadState <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> tsRunning
       <span class="keyword1">else</span> SetThreadState <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">gno</span></span> tsAborted<span class="main">)</span>
 <span class="keyword1">else</span> <span class="free"><span class="bound">s</span></span><span class="main">)</span>"</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> WakeUpAndWait<span class="main">::</span><span class="quoted"><span class="quoted"><span class="language">"State <span class="main">⇒</span> globalid_t <span class="main">⇒</span> globalid_t <span class="main">⇒</span> threadstate_t <span class="main">⇒</span> State"</span></span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted"><span class="language">"<span class="free">WakeUpAndWait</span> <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">running_tcb</span></span> <span class="free"><span class="bound">waiting_tcb</span></span> <span class="free"><span class="bound">wait_state</span></span> <span class="main">=</span> 
<span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound">running_tcb</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound">waiting_tcb</span></span> <span class="main">∈</span> active_threads <span class="free"><span class="bound">s</span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>isWaiting <span class="free"><span class="bound">wait_state</span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>isRunning <span class="main">(</span>GetThreadState <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">running_tcb</span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>isWaiting <span class="main">(</span>GetThreadState <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">waiting_tcb</span></span><span class="main">)</span><span class="main">)</span>
 <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound">waiting_tcb</span></span> <span class="main">∈</span> kIntThreads
       <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> SetThreadState <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">running_tcb</span></span> <span class="free"><span class="bound">wait_state</span></span> 
              <span class="keyword1">in</span> SetThreadState <span class="bound">S1</span> <span class="free"><span class="bound">waiting_tcb</span></span> tsAborted<span class="main">)</span>
       <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">S1</span> <span class="main">=</span> SetThreadState <span class="free"><span class="bound">s</span></span> <span class="free"><span class="bound">running_tcb</span></span> <span class="free"><span class="bound">wait_state</span></span> 
              <span class="keyword1">in</span> SetThreadState <span class="bound">S1</span> <span class="free"><span class="bound">waiting_tcb</span></span> tsRunning<span class="main">)</span> <span class="main">)</span>
 <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound">s</span></span><span class="main">)</span><span class="main">)</span>"</span></span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre></body>